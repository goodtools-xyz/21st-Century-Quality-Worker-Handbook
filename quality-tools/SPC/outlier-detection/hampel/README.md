# Hampel异常值检验方法

## 概念简介

Hampel异常值检验方法是一种稳健的异常值检测技术，基于中位数绝对偏差（MAD）和中位数统计量，对数据分布的假设要求较低，对异常值具有很强的抵抗力。该方法由Frank R. Hampel于1972年提出，是统计过程控制中常用的非参数异常值检验方法之一。

Hampel方法特别适用于以下情况：
- 数据分布不符合正态分布
- 数据集中可能存在多个异常值
- 需要一种对异常值不敏感的稳健统计方法
- 样本量较小或中等的数据集

## 基本原理

Hampel异常值检验方法的核心思想是：
1. 使用中位数作为位置估计量，代替传统的均值（均值对异常值敏感）
2. 使用中位数绝对偏差（MAD）作为尺度估计量，代替传统的标准差
3. 构建基于MAD的标准化残差，用于识别异常值

该方法通过一个窗口（通常是移动窗口）来处理数据，对于窗口内的每个数据点，计算其与中位数的绝对偏差，并将其标准化，然后与预设阈值进行比较。

## 数学原理与计算公式

### 1. 中位数绝对偏差（MAD）计算

对于数据集 ${X_1, X_2, \ldots, X_n}$，中位数绝对偏差计算如下：

1. 计算数据集的中位数：$\text{Median} = \text{median}(X_1, X_2, \ldots, X_n)$
2. 计算每个数据点与中位数的绝对偏差：$|X_i - \text{Median}|$
3. 计算这些绝对偏差的中位数，即MAD：$\text{MAD} = \text{median}(|X_1 - \text{Median}|, |X_2 - \text{Median}|, \ldots, |X_n - \text{Median}|)$

### 2. 稳健标准差的计算

为了使MAD与标准差在正态分布下具有可比性，通常将其乘以一个常数因子（对于正态分布，常数为1.4826）：

$\text{MADN} = \text{MAD} \times 1.4826$

其中，MADN表示归一化的中位数绝对偏差，用作稳健的标准差估计。

### 3. Hampel标识符（Hampel Identifier）

对于数据集中的每个点 $X_i$，Hampel标识符定义为：

$H_i = \frac{|X_i - \text{Median}|}{\text{MADN}}$ ，当MADN > 0

### 4. 异常值判定规则

当 $H_i > k$ 时，判定 $X_i$ 为异常值，其中 $k$ 是预设的阈值。通常：
- 当 $k=3$ 时，对应正态分布下约99.7%的置信水平
- 当 $k=3.5$ 时，是一个常用的稳健选择
- 当 $k=2$ 时，灵敏度更高，但可能增加误判率

## 移动窗口Hampel滤波器

在时间序列数据的异常值检测中，Hampel方法通常以移动窗口的形式应用：

1. 设定一个窗口大小 $w$（通常为奇数）
2. 将窗口沿时间序列滑动，对每个窗口位置：
   - 计算窗口内数据的中位数
   - 计算窗口内数据的MAD
   - 计算窗口中心数据点的Hampel标识符
   - 根据阈值判断是否为异常值

这种滑动窗口方式特别适用于检测时间序列中的局部异常。

## 实施步骤

### 基础Hampel异常值检验实施步骤：

1. **数据收集与预处理**：确保数据格式正确，处理缺失值
2. **计算中位数**：计算数据集的中位数
3. **计算MAD**：计算每个数据点与中位数的绝对偏差，再计算这些绝对偏差的中位数
4. **计算MADN**：将MAD乘以1.4826得到归一化的中位数绝对偏差
5. **计算Hampel标识符**：对每个数据点计算 $H_i$
6. **设定阈值**：根据应用场景选择合适的阈值 $k$（通常为3或3.5）
7. **识别异常值**：所有 $H_i > k$ 的数据点被标记为异常值
8. **异常值审查**：结合专业知识验证识别出的异常值

### 移动窗口Hampel检验实施步骤：

1. **数据收集与预处理**
2. **设定窗口大小**：根据数据特性选择合适的窗口大小（通常为3, 5, 7等奇数）
3. **滑动窗口计算**：对每个窗口位置执行步骤3-6
4. **记录异常值位置**：标记所有被判定为异常值的数据点
5. **异常值审查与处理**

## 优缺点分析

### 优点

1. **稳健性强**：即使数据集中存在多个异常值，也能保持良好的检测性能
2. **非参数方法**：不依赖于数据的分布假设，适用于各种分布类型的数据
3. **计算简单**：算法直观，易于实现
4. **适用性广**：可应用于静态数据集和时间序列数据
5. **对极端值不敏感**：中位数和MAD统计量对极端值具有抵抗力

### 缺点

1. **计算效率**：在大数据集上，尤其是使用移动窗口时，计算成本较高
2. **阈值选择**：阈值 $k$ 的选择需要根据具体应用场景调整，没有放之四海而皆准的最佳值
3. **局部异常检测限制**：在非平稳时间序列中，单一窗口大小可能无法适应所有局部特性
4. **边界效应**：在时间序列的开始和结束部分，移动窗口可能无法完整覆盖

## 与其他异常值检验方法的比较

| 检验方法 | 稳健性 | 计算复杂度 | 数据分布假设 | 适用数据类型 | 多异常值处理能力 |
|---------|-------|-----------|------------|------------|----------------|
| Grubbs检验 | 低 | 低 | 正态分布 | 静态数据 | 弱 |
| Dixon检验 | 低 | 低 | 正态分布 | 小样本数据 | 弱 |
| IQR方法 | 高 | 低 | 无严格假设 | 静态数据 | 中 |
| MAD方法 | 高 | 低 | 无严格假设 | 静态数据 | 中 |
| **Hampel方法** | **高** | **中** | **无严格假设** | **静态和时间序列数据** | **强** |

## 应用场景

Hampel异常值检验方法在以下质量管理和数据分析场景中特别有用：

1. **过程监控**：检测生产过程中的异常波动
2. **质量控制**：识别质量数据中的异常观测值
3. **传感器数据处理**：处理可能包含噪声和异常值的传感器数据
4. **时间序列分析**：检测时间序列数据中的异常模式
5. **财务数据分析**：识别财务数据中的异常交易或值
6. **环境监测数据**：检测环境参数中的异常读数
7. **工业设备故障预测**：通过检测异常值预测潜在故障

## 实例说明

### 示例1：静态数据集异常值检测

假设有以下数据集：
$[10, 12, 11, 15, 13, 100, 12, 11, 14, 12]$（其中100是异常值）

**计算步骤**：
1. 计算中位数：12
2. 计算每个数据点与中位数的绝对偏差：$[2, 0, 1, 3, 1, 88, 0, 1, 2, 0]$ 
3. 计算MAD：median($[2, 0, 1, 3, 1, 88, 0, 1, 2, 0]$) = 1
4. 计算MADN：1 × 1.4826 ≈ 1.4826
5. 计算Hampel标识符：对于值100，$H = |100 - 12| / 1.4826 ≈ 59.35$，远大于阈值3.5
6. 结论：100被识别为异常值

### 示例2：移动窗口应用

对于时间序列数据，使用窗口大小为3的移动窗口Hampel滤波器：

假设数据点为：$[5, 6, 7, 8, 100, 10, 11, 12]$（其中100是异常值）

**窗口1**（数据点5,6,7）：中位数=6，MAD=1，MADN≈1.4826
- 中心数据点6的Hampel标识符=0，正常

**窗口2**（数据点6,7,8）：中位数=7，MAD=1，MADN≈1.4826
- 中心数据点7的Hampel标识符=0，正常

**窗口3**（数据点7,8,100）：中位数=8，MAD=1，MADN≈1.4826
- 中心数据点8的Hampel标识符=0，正常

**窗口4**（数据点8,100,10）：中位数=10，MAD=2，MADN≈2.9652
- 中心数据点100的Hampel标识符=|100-10|/2.9652≈30.35，远大于阈值3.5，标记为异常

## 注意事项

1. **窗口大小选择**：在移动窗口应用中，窗口大小应根据数据的特性和预期的异常模式选择
2. **阈值调整**：阈值 $k$ 的选择需要平衡异常值检测的灵敏度和误报率
3. **数据预处理**：在应用Hampel方法前，应考虑是否需要进行数据转换或归一化
4. **边界处理**：对于时间序列数据，需要注意窗口在边界处的处理方法
5. **结合专业知识**：统计检验结果应与领域专业知识相结合，避免纯统计判断
6. **多方法验证**：重要分析中，建议使用多种异常值检验方法进行交叉验证
7. **计算实现**：在大数据集上，应考虑算法的计算效率和优化方法

Hampel异常值检验方法作为一种稳健的非参数异常值检测技术，在统计过程控制和质量管理中具有重要应用价值，特别适用于那些不符合正态分布且可能包含多个异常值的数据集。